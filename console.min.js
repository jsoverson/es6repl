"use strict";var _classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),Console=function(){function t(t,e){var n=t.getDoc(),r=n.lastLine(),i=n.getLine(r),o=CodeMirror.Pos(r,i.length+1);return n.replaceRange(e,o),[o,CodeMirror.Pos(n.lastLine())]}var e=function(){function e(t){var n=this,r=void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,e),r.theme="eclipse",r.mode="javascript",this.container=t,this.container.classList.add("jsconsole"),this.logBuffer=[],this.history=[],this.historyIndex=-1,this.events={};var i=function(){var t=n.input.getValue().trim();t&&n.exec(t)},o=function(){CodeMirror.commands.newlineAndIndent(n.input)},u=function(){n.resetInput()},s=function(t,e){var r=n.input.getCursor();0===r.line&&0===r.ch?(n.historyIndex++,n.historyIndex>n.history.length-1&&(n.historyIndex=n.history.length-1),n.resetInput(n.history[n.historyIndex])):CodeMirror.commands.goLineUp(n.input)},a=function(t,e){var r=n.input.getCursor(),i=n.input.lastLine();r.line===i?(n.historyIndex--,n.historyIndex<-1&&(n.historyIndex=-1),n.resetInput(n.history[n.historyIndex])):CodeMirror.commands.goLineDown(n.input)},l={Up:s,Down:a,"Ctrl-C":u,Enter:i,"Shift-Enter":o},c=document.createElement("div"),p=document.createElement("div");c.className="jsconsole-output",p.className="jsconsole-input",this.container.appendChild(c),this.container.appendChild(p),this.input=CodeMirror(p,{theme:r.theme,mode:r.mode,extraKeys:l,tabSize:2,indentUnit:2,undoDepth:100,autofocus:!0,lineWrapping:!0,viewportMargin:1/0,gutters:["repl"]}),this.output=CodeMirror(c,{theme:r.theme,mode:r.mode,gutters:["repl"],tabSize:2,viewportMargin:1/0,lineWrapping:!0,indentUnit:2,readOnly:!0}),this.resetOutput(),this.input.on("focus",function(){var t=n.output.getCursor();n.output.setSelection(t,t)}),this.output.on("focus",function(){var t=n.input.getCursor();n.input.setSelection(t,t)}),this.output.on("keydown",function(t,e){e.metaKey||e.ctrlKey?67===e.which||86===e.which&&n.input.triggerOnKeyDown(e):(n.input.triggerOnKeyDown(e),n.input.focus())}),c.addEventListener("mouseup",function(t){0===n.output.getSelection().length&&setTimeout(function(){return n.input.focus()},0)}),this.input.setMarker=this.output.setMarker=function(t,e){this.setGutterMarker(t,"repl",e.cloneNode())},this.resetInput()}return _createClass(e,[{key:"on",value:function(t,e){this.events[t]=e}},{key:"off",value:function(t){delete this.events[t]}},{key:"trigger",value:function(t,e){"function"==typeof this.events[t]&&this.events[t](e)}},{key:"flushLogBuffer",value:function(){var t=this;this.logBuffer.length&&(this.logBuffer.forEach(function(e){t.print(e),t.origConsoleLog(e)}),this.logBuffer.length=0)}},{key:"addHistory",value:function(t){this.historyIndex=-1,this.history.unshift(t)}},{key:"appendEntry",value:function(t,e){this.trigger("entry",{input:t,output:e});var n=this.appendOutput(t.toString().trim());this.output.setMarker(n[0].line,u);for(var r=n[0].line;r<=n[1].line;r++)r>n[0].line&&this.output.setMarker(r,s),this.output.addLineClass(r,"text","prev-command");this.flushLogBuffer();var o=this.parseOutput(e);n=this.appendOutput(o.formatted);var l=o.value instanceof Error;l?this.output.setMarker(n[0].line,i):this.output.setMarker(n[0].line,a);for(var r=n[0].line;r<=n[1].line;r++)this.output.addLineClass(r,"text","completion-value"),this.output.addLineClass(r,"text",o["class"]);this.output.addLineClass(n[1].line,"text","completion-value-end")}},{key:"parseOutput",value:function(t){var e=typeof t;t instanceof Error&&(e="error"),null===t&&(e="null");var n={value:t,type:e,"class":"type-"+e};switch(e){case"string":n.formatted='"'+t+'"',n["class"]="string";break;case"undefined":n.formatted="undefined";break;case"null":n.formatted="null";break;case"object":case"array":n.formatted=JSON.stringify(t);break;case"error":n.formatted=t.message.trim();break;default:n.formatted=t.toString().trim()}return n}},{key:"evaluate",value:function(t){var e={};try{e.completionValue=eval.call(null,t)}catch(n){e.error=!0,e.completionValue=n,e.recoverable=n instanceof SyntaxError&&n.message.match("^Unexpected (token|end)")}return e}},{key:"exec",value:function(t){var e=this;this.isEvaluating=!0;var i=this.evaluate(t);if(i){this.isEvaluating=!1;var o=this.input.getDoc();i.error&&!i.recoverable?(this.appendEntry(t,i.completionValue),this.addHistory(t),this.resetInput()):i.recoverable?CodeMirror.commands.newlineAndIndent(this.input):(this.appendEntry(t,i.completionValue),this.addHistory(t),this.resetInput()),o.eachLine(function(t){0===t.lineNo()?e.input.setMarker(t,n):e.input.setMarker(t,r)})}}},{key:"resetInput",value:function(){var t=void 0===arguments[0]?"":arguments[0];this.input.setValue(t.toString()),this.input.execCommand("goDocEnd"),this.input.setMarker(0,n)}},{key:"resetOutput",value:function(){this.output.setSize(null,8),this.output.setValue("")}},{key:"appendOutput",value:function(e){this.output.setSize(null,"auto");var n,r=this.output.getDoc();return r.getLine(r.lastLine()).match(/^\s*$/)?n=t(this.output,e.toString()):(n=t(this.output,"\n"+e.toString()),n[0].line=n[0].line+1),n}},{key:"print",value:function(t){for(var e=void 0===arguments[1]?"message":arguments[1],n=void 0===arguments[2]?document.createElement("span"):arguments[2],r=this.appendOutput(t),i=r[0].line;i<=r[1].line;i++)this.output.addLineClass(i,"text",e),this.output.setMarker(i,n);return r}},{key:"simpleFormatter",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;e>r;r++)n[r-1]=arguments[r];var i=0;return t.replace(/%./gm,function(t,e,r){return n[i++]})}},{key:"appendInput",value:function(e){return t(this.input,e.toString())}},{key:"wrapLog",value:function(t){var e=this,n=t.log.bind(t);return t.log=function(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];e.logBuffer.push(e.simpleFormatter.apply(e,n)),e.isEvaluating||e.flushLogBuffer()},this.origConsoleLog=n}},{key:"setMode",value:function(t){this.input.setOption("mode",t),this.output.setOption("mode",t)}},{key:"setTheme",value:function(t){this.input.setOption("theme",t),this.output.setOption("theme",t)}}]),e}(),n=document.createElement("span"),r=document.createElement("span"),i=document.createElement("span"),o=document.createElement("span"),u=document.createElement("span"),s=document.createElement("span"),a=document.createElement("span");return i.className="console-error gutter-icon",o.className="console-info gutter-icon",n.className="prompt gutter-icon",r.className="prompt-continuation gutter-icon",u.className="prev-command gutter-icon",s.className="prev-command-continuation gutter-icon",a.className="completion-value gutter-icon",e}();